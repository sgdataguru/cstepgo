generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  phone         String?  @unique
  name          String
  passwordHash  String
  role          UserRole @default(PASSENGER)
  emailVerified Boolean  @default(false)
  phoneVerified Boolean  @default(false)
  avatar        String?
  bio           String?
  isFirstLogin  Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  analyticsEvents       AnalyticsEvent[]
  bookings              Booking[]
  driverProfile         Driver?
  sessions              Session[]
  trips                 Trip[]                      @relation("TripOrganizer")
  tripVisibility        TripDriverVisibility[]
  tripAcceptanceLog     TripAcceptanceLog[]         @relation("DriverAcceptanceLog")
  driverLocation        DriverLocation?
  conversationParticipants ConversationParticipant[]
  messagesSent          Message[]                   @relation("MessageSender")

  @@index([email])
  @@index([phone])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Driver {
  id     String       @id @default(cuid())
  userId String       @unique
  status DriverStatus @default(PENDING)

  // Vehicle Information
  vehicleType       String
  vehicleModel      String
  vehicleMake       String
  vehicleYear       Int
  licensePlate      String
  vehicleColor      String?
  passengerCapacity Int     @default(4)
  luggageCapacity   Int     @default(2)

  // License & Documentation
  licenseNumber String
  licenseExpiry DateTime
  documentsUrl  Json

  // Profile Information
  bio             String?
  coverPhotoUrl   String?
  yearsExperience Int     @default(0)
  languages       Json? // Array of {code, name, proficiency}

  // Verification
  verificationBadges Json? // Array of verification badges
  verificationLevel  String  @default("BASIC") // BASIC, STANDARD, PREMIUM
  isVerified         Boolean @default(false)

  // Performance & Stats
  rating           Float   @default(0)
  reviewCount      Int     @default(0)
  completedTrips   Int     @default(0)
  totalDistance    Float   @default(0) // in kilometers
  totalEarnings    Decimal @default(0)
  onTimePercentage Float   @default(100)
  cancellationRate Float   @default(0)
  responseTime     String  @default("< 1 hour")

  // Availability
  availability    String  @default("OFFLINE") // AVAILABLE, BUSY, OFFLINE
  currentLocation String? // e.g., "Currently in Almaty"

  // Enhanced Availability Management
  acceptsPrivateTrips Boolean   @default(true) @map("accepts_private_trips")
  acceptsSharedTrips  Boolean   @default(true) @map("accepts_shared_trips")
  acceptsLongDistance Boolean   @default(true) @map("accepts_long_distance")
  lastActivityAt      DateTime? @map("last_activity_at")
  autoOfflineMinutes  Int       @default(30) @map("auto_offline_minutes")

  // Application Status
  appliedAt       DateTime  @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  // Admin Registration Fields
  driverId        String    @unique // DRV-YYYYMMDD-XXXXX
  fullName        String?
  nationalId      String?
  homeCity        String?
  serviceRadiusKm Int       @default(50)
  willingToTravel Json? // Array of strings: ["domestic", "cross_border_kz"]
  registeredBy    String? // Admin user ID
  lastLoginAt     DateTime?

  // Admin Approval Workflow
  approvalStatus       String    @default("PENDING_REVIEW") @map("approval_status") // PENDING_REVIEW, APPROVED, REJECTED
  approvedByAdmin      String?   @map("approved_by")
  approvedAtAdmin      DateTime? @map("approved_at_admin")
  rejectionReasonAdmin String?   @map("rejection_reason_admin")
  adminNotes           String?   @map("admin_notes")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                  User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  payouts               Payout[]
  trips                 Trip[]
  vehicles              Vehicle[]
  reviews               Review[]
  credentialDeliveries  DriverCredentialDelivery[]
  availabilitySchedules DriverAvailabilitySchedule[]
  availabilityHistory   DriverAvailabilityHistory[]

  @@index([userId])
  @@index([status])
  @@index([availability])
  @@index([rating])
  @@index([driverId])
  @@index([lastActivityAt])
  @@index([approvalStatus])
}

model Vehicle {
  id       String @id @default(cuid())
  driverId String

  // Basic Info
  make         String
  model        String
  year         Int
  color        String
  licensePlate String
  type         String // SEDAN, SUV, MINIBUS, BUS, VAN

  // Capacity
  passengerCapacity Int
  luggageCapacity   Int

  // Features
  amenities Json // Array of amenities
  photos    Json // Array of photo URLs

  // Documentation
  insuranceExpiryDate    DateTime?
  registrationExpiryDate DateTime?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([isActive])
}

model Review {
  id       String @id @default(cuid())
  driverId String
  tripId   String

  // Review Content
  rating  Int // 1-5 stars
  comment String?

  // Reviewer Info
  reviewerId       String
  reviewerName     String
  reviewerPhotoUrl String?

  // Driver Response
  response    String?
  respondedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([tripId])
  @@index([rating])
  @@index([createdAt])
}

model DriverCredentialDelivery {
  id           String          @id @default(cuid())
  driverId     String
  channel      DeliveryChannel
  status       DeliveryStatus
  sentAt       DateTime        @default(now())
  deliveredAt  DateTime?
  errorMessage String?

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, channel])
  @@index([status])
}

model Trip {
  id             String     @id @default(cuid())
  title          String
  description    String
  organizerId    String
  driverId       String?
  departureTime  DateTime
  returnTime     DateTime
  timezone       String     @default("Asia/Almaty")
  originName     String
  originAddress  String
  originLat      Float
  originLng      Float
  destName       String
  destAddress    String
  destLat        Float
  destLng        Float
  totalSeats     Int
  availableSeats Int
  basePrice      Decimal
  currency       String     @default("KZT")
  platformFee    Decimal
  itinerary      Json
  status         TripStatus @default(DRAFT)
  metadata       Json?

  // Trip Type & Multi-Tenant Fields
  tripType       TripType   @default(PRIVATE) @map("trip_type")
  tenantId       String?    @map("tenant_id") // Organization/tenant identifier
  pricePerSeat   Decimal?   @map("price_per_seat") // For shared rides

  // Driver Discovery Fields
  driverDiscoveryRadius Int      @default(10) @map("driver_discovery_radius")
  estimatedEarnings     Decimal? @map("estimated_earnings")
  difficultyLevel       String   @default("normal") @map("difficulty_level")
  tripUrgency           String   @default("normal") @map("trip_urgency")

  // Trip Acceptance Fields
  acceptanceDeadline     DateTime? @map("acceptance_deadline")
  offeredToDriverId      String?   @map("offered_to_driver_id")
  acceptanceResponseTime Int?      @map("acceptance_response_time") // in seconds

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  cancelledAt DateTime?

  // Relations
  bookings         Booking[]
  driverVisibility TripDriverVisibility[]
  acceptanceLog    TripAcceptanceLog[]
  driver           Driver?                @relation(fields: [driverId], references: [id])
  organizer        User                   @relation("TripOrganizer", fields: [organizerId], references: [id])
  conversation     Conversation?

  @@index([organizerId])
  @@index([driverId])
  @@index([status])
  @@index([departureTime])
  @@index([originLat, originLng])
  @@index([status, driverDiscoveryRadius])
  @@index([acceptanceDeadline])
  @@index([offeredToDriverId])
  @@index([tripType, status])
  @@index([tenantId])
}

model Booking {
  id                String            @id @default(cuid())
  tripId            String
  userId            String
  status            BookingStatus     @default(PENDING)
  seatsBooked       Int               @default(1)
  totalAmount       Decimal
  currency          String            @default("KZT")
  passengers        Json
  notes             String?
  paymentMethodType PaymentMethodType @default(ONLINE) @map("payment_method_type")
  
  // Payout tracking
  payoutId          String?           @map("payout_id")
  payoutSettled     Boolean           @default(false) @map("payout_settled")
  settledAt         DateTime?         @map("settled_at")
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  confirmedAt       DateTime?
  cancelledAt       DateTime?
  trip              Trip              @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id])
  payment           Payment?

  @@index([tripId])
  @@index([userId])
  @@index([status])
  @@index([paymentMethodType])
  @@index([payoutSettled])
  @@index([payoutId])
}

model Payment {
  id                 String        @id @default(cuid())
  bookingId          String        @unique
  stripeIntentId     String?       @unique
  stripeClientSecret String?
  amount             Decimal
  currency           String        @default("KZT")
  status             PaymentStatus @default(PENDING)
  paymentMethod      String?
  last4              String?
  metadata           Json?
  errorMessage       String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  succeededAt        DateTime?
  failedAt           DateTime?
  booking            Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([stripeIntentId])
  @@index([status])
}

model Payout {
  id               String       @id @default(cuid())
  driverId         String
  amount           Decimal
  currency         String       @default("KZT")
  status           PayoutStatus @default(PENDING)
  
  // Payment provider details
  payoutMethod     String       @default("MOCK") @map("payout_method") // MOCK, STRIPE_CONNECT, BANK_TRANSFER
  payoutProvider   String       @default("MOCK") @map("payout_provider")
  stripeTransferId String?      @unique @map("stripe_transfer_id")
  providerMetadata Json?        @map("provider_metadata")
  
  // Period and trip details
  periodStart      DateTime     @map("period_start")
  periodEnd        DateTime     @map("period_end")
  tripsCount       Int          @default(0) @map("trips_count")
  bookingsCount    Int          @default(0) @map("bookings_count")
  
  // Multi-tenant support
  tenantId         String?      @map("tenant_id")
  
  // Calculation details stored as metadata
  metadata         Json?        // Contains: bookingIds[], grossAmount, platformFee, netAmount, etc.
  
  // Timestamps
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  processedAt      DateTime?    @map("processed_at")
  failedAt         DateTime?    @map("failed_at")
  errorMessage     String?      @map("error_message")
  
  // Relations
  driver           Driver       @relation(fields: [driverId], references: [id])

  @@index([driverId])
  @@index([status])
  @@index([tenantId])
  @@index([periodStart, periodEnd])
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventName String
  userId    String?
  metadata  Json
  sessionId String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([eventName])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
}

model WebhookLog {
  id              String    @id @default(cuid())
  source          String
  eventType       String
  eventId         String    @unique
  payload         Json
  processed       Boolean   @default(false)
  processingError String?
  createdAt       DateTime  @default(now())
  processedAt     DateTime?

  @@index([source])
  @@index([eventId])
  @@index([processed])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String?
  type      String
  channel   String
  recipient String
  subject   String?
  body      String
  status    String
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model TripDriverVisibility {
  id             String    @id @default(cuid())
  tripId         String    @map("trip_id")
  driverId       String    @map("driver_id")
  shownAt        DateTime  @default(now()) @map("shown_at")
  viewedAt       DateTime? @map("viewed_at")
  responseAction String?   @map("response_action") // 'accepted', 'declined', 'expired'
  responseAt     DateTime? @map("response_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  trip   Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  driver User @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([tripId, driverId])
  @@index([driverId, shownAt])
  @@index([tripId, responseAction])
}

model DriverLocation {
  driverId    String   @id @map("driver_id")
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  heading     Decimal? @db.Decimal(5, 2) // Direction in degrees
  speed       Decimal? @db.Decimal(5, 2) // Speed in km/h
  accuracy    Decimal? @db.Decimal(8, 2) // GPS accuracy in meters
  lastUpdated DateTime @default(now()) @map("last_updated")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  driver User @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([latitude, longitude])
  @@index([isActive, lastUpdated])
}

model TripAcceptanceLog {
  id                  String               @id @default(cuid())
  tripId              String               @map("trip_id")
  driverId            String               @map("driver_id")
  action              TripAcceptanceAction // 'offered', 'accepted', 'declined', 'timeout'
  offeredAt           DateTime             @default(now()) @map("offered_at")
  respondedAt         DateTime?            @map("responded_at")
  responseTimeSeconds Int?                 @map("response_time_seconds")
  ipAddress           String?              @map("ip_address")
  userAgent           String?              @map("user_agent")
  timeoutDuration     Int                  @default(30) @map("timeout_duration") // seconds
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at")

  // Relations
  trip   Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  driver User @relation("DriverAcceptanceLog", fields: [driverId], references: [id], onDelete: Cascade)

  @@index([tripId, driverId])
  @@index([action, offeredAt])
  @@index([responseTimeSeconds])
}

model DriverAvailabilitySchedule {
  id       String @id @default(cuid())
  driverId String @map("driver_id")

  // Schedule Details
  startTime        DateTime @map("start_time")
  endTime          DateTime @map("end_time")
  scheduleType     String   @default("break") // 'break', 'unavailable', 'custom'
  reason           String?
  isRecurring      Boolean  @default(false) @map("is_recurring")
  recurringPattern Json?    @map("recurring_pattern") // {dayOfWeek, frequency, etc}

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, startTime, endTime])
  @@index([isActive, startTime])
  @@map("driver_availability_schedules")
}

model DriverAvailabilityHistory {
  id       String @id @default(cuid())
  driverId String @map("driver_id")

  // Status Changes
  previousStatus String  @map("previous_status")
  newStatus      String  @map("new_status")
  changeReason   String? @map("change_reason")

  // Context
  triggeredBy String  @default("driver") @map("triggered_by") // 'driver', 'system', 'admin'
  ipAddress   String? @map("ip_address")
  userAgent   String? @map("user_agent")
  metadata    Json? // Additional context

  // Timestamp
  changedAt DateTime @default(now()) @map("changed_at")

  // Relations
  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, changedAt])
  @@index([triggeredBy, changedAt])
  @@map("driver_availability_history")
}

enum UserRole {
  PASSENGER
  DRIVER
  ADMIN
}

enum DriverStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum TripType {
  PRIVATE
  SHARED
}

enum TripStatus {
  DRAFT
  PUBLISHED
  OFFERED
  FULL
  IN_PROGRESS
  DEPARTED
  EN_ROUTE
  DRIVER_ARRIVED
  PASSENGERS_BOARDED
  IN_TRANSIT
  DELAYED
  ARRIVED
  COMPLETED
  CANCELLED
}

enum TripAcceptanceAction {
  OFFERED
  ACCEPTED
  DECLINED
  TIMEOUT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
}

enum PaymentMethodType {
  ONLINE
  CASH_TO_DRIVER
}

enum DeliveryChannel {
  WHATSAPP
  SMS
  EMAIL
}

enum DeliveryStatus {
  SENT
  DELIVERED
  FAILED
  READ
}

model Conversation {
  id     String @id @default(cuid())
  tripId String @unique

  // Metadata
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  trip         Trip                      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  messages     Message[]
  participants ConversationParticipant[]

  @@index([tripId])
  @@index([lastMessageAt])
}

model ConversationParticipant {
  id             String @id @default(cuid())
  conversationId String @map("conversation_id")
  userId         String @map("user_id")

  // Read status tracking
  lastReadAt  DateTime? @map("last_read_at")
  unreadCount Int       @default(0) @map("unread_count")

  // Settings
  notificationsEnabled Boolean @default(true) @map("notifications_enabled")

  // Timestamps
  joinedAt DateTime  @default(now()) @map("joined_at")
  leftAt   DateTime? @map("left_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId, conversationId])
  @@index([unreadCount])
}

model Message {
  id             String @id @default(cuid())
  conversationId String @map("conversation_id")
  senderId       String @map("sender_id")

  // Content
  content  String      @db.Text
  type     MessageType @default(TEXT)
  metadata Json? // For attachments, locations, etc.

  // Status
  status MessageStatus @default(SENT)

  // Moderation
  isReported   Boolean @default(false) @map("is_reported")
  reportReason String? @map("report_reason")
  isHidden     Boolean @default(false) @map("is_hidden")

  // Timestamps
  sentAt      DateTime  @default(now()) @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  readAt      DateTime? @map("read_at")
  editedAt    DateTime? @map("edited_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, sentAt])
  @@index([senderId])
  @@index([isReported])
  @@index([sentAt])
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  LOCATION
  SYSTEM
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

// OTP Model for SMS/WhatsApp verification
model OTP {
  id         String    @id @default(cuid())
  phone      String
  codeHash   String    @map("code_hash")
  expiresAt  DateTime  @map("expires_at")
  attempts   Int       @default(0)
  verified   Boolean   @default(false)
  createdAt  DateTime  @default(now()) @map("created_at")
  verifiedAt DateTime? @map("verified_at")

  @@index([phone])
  @@index([expiresAt])
}

// Document Verification Model
model DocumentVerification {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  driverId       String?   @map("driver_id")
  documentType   String    @map("document_type") // LICENSE, INSURANCE, REGISTRATION, ID_CARD, etc.
  documentNumber String?   @map("document_number")
  documentUrl    String    @map("document_url")
  status         String    @default("PENDING") // PENDING, VERIFIED, REJECTED
  uploadedAt     DateTime  @default(now()) @map("uploaded_at")
  verifiedAt     DateTime? @map("verified_at")
  verifiedBy     String?   @map("verified_by")
  rejectionReason String?  @map("rejection_reason")
  expiryDate     DateTime? @map("expiry_date")
  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")

  @@index([userId])
  @@index([driverId])
  @@index([status])
  @@index([documentType])
}

// File Upload Model
model FileUpload {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  originalName String    @map("original_name")
  storedName   String    @map("stored_name")
  mimeType     String    @map("mime_type")
  sizeBytes    Int       @map("size_bytes")
  s3Bucket     String?   @map("s3_bucket")
  s3Key        String?   @map("s3_key")
  url          String
  purpose      String // PROFILE_IMAGE, DOCUMENT, VEHICLE_PHOTO, etc.
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")

  @@index([userId])
  @@index([purpose])
  @@index([createdAt])
}

// Admin Action Audit Log
model AdminAction {
  id         String   @id @default(cuid())
  adminId    String   @map("admin_id")
  actionType String   @map("action_type") // APPROVE_DRIVER, REJECT_DRIVER, VERIFY_DOCUMENT, etc.
  targetType String   @map("target_type") // DRIVER, DOCUMENT, USER, etc.
  targetId   String   @map("target_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([actionType])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// Refresh Token Model
model RefreshToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  tokenHash String    @unique @map("token_hash")
  sessionId String    @map("session_id")
  expiresAt DateTime  @map("expires_at")
  revoked   Boolean   @default(false)
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([tokenHash])
  @@index([sessionId])
  @@index([expiresAt])
}
